# Fleet's Fleet Enterprise Edition (EE) license applies to the code in this file. Read about the license here: https://github.com/fleetdm/fleet/blob/main/ee/LICENSE

---
- name: macOS - CIS - Ensure FileVault is enabled (MDM required)
  platform: darwin
  description: Checks that FileVault is enabled. FileVault secures a system's data by automatically encrypting its boot volume and requiring a password or recovery key to access it. This policy checks that filevault is enabled on the device and that the user is not allowed to disable it.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that enables FileVault and disables turning it off.
    Graphical method:
      Perform the following steps to ensure FileVault Is Enabled:
        1. Open System Settings
        2. Select Privacy & Privacy
        3. Verify that FileVault states FileVault is turned on for the disk "<disk name>"
        4. Select Privacy & Security
        5. Select Profile
        6. Verify that an installed profile has FileVault Can't Disable set to True
  query: |
    SELECT 1 WHERE 
      EXISTS (
        SELECT 1 FROM managed_policies WHERE 
            domain='com.apple.MCX' AND 
            name='dontAllowFDEDisable' AND 
            (value = 1 OR value = 'true') AND 
            username = ''
        )
      AND NOT EXISTS (
        SELECT 1 FROM managed_policies WHERE 
            domain='com.apple.MCX' AND 
            name='dontAllowFDEDisable' AND 
            (value != 1 AND value != 'true')
        )
      AND EXISTS (
        SELECT 1 FROM disk_encryption WHERE 
            user_uuid IS NOT "" AND 
            filevault_status = 'on' 
        );